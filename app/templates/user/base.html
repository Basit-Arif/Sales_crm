<!DOCTYPE html>
<html lang="en">
<head>
 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Dashboard{% endblock %}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .sidebar {
      height: 100vh;
      background-color: #343a40;
      color: white;
      padding-top: 1rem;
    }
    .sidebar a {
      color: #ddd;
      display: block;
      padding: 0.75rem 1.25rem;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #495057;
      color: white;
    }
    .active-link {
      background-color: #007bff;
      color: white !important;
    }
    .flash-message {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1050;
      min-width: 300px;
    }

    .sidebar .dropdown-toggle {
      padding: 0.75rem 1.25rem;
      display: block;
      width: 100%;
      color: #ddd;
    }

    .sidebar .dropdown-toggle:hover {
      background-color: #495057;
      color: white;
    }

    .sidebar .dropdown-menu {
      background-color: #343a40;
      border: none;
      margin-left: 1.25rem;
    }

    .sidebar .dropdown-item {
      color: #ddd;
    }

    .sidebar .dropdown-item:hover {
      background-color: #495057;
      color: white;
    }
  </style>
  
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="{{ url_for('user.index') }}">CRM Dashboard</a>
    <div class="ml-auto d-flex align-items-center">
        <div class="dropdown">
            <a href="#" id="notif-bell" class="text-white mr-3 dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <i class="fas fa-bell"></i>
              <span class="badge badge-danger d-none" id="notif-badge">1</span>
            </a>
            <div class="dropdown-menu dropdown-menu-right p-2" aria-labelledby="notif-bell" id="notif-dropdown" style="min-width: 300px; max-height: 300px; overflow-y: auto;">
              <span class="text-muted small">No new messages</span>
            </div>
          </div>
      <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
    </div>
  </nav>
  <div class="container-fluid" id="main-container" style="margin-top: 56px;">
    <div class="row">
      <nav class="col-md-2 sidebar" style="position: fixed; top: 56px; bottom: 0; left: 0; overflow-y: auto;">
        <h5 class="text-center">CRM Panel</h5>
        <a href="{{ url_for('user.index') }}" class="{% if request.endpoint == 'user.index' %}active-link{% endif %}"><i class="fas fa-home"></i> Dashboard</a>
        
        <div class="dropdown">
          <a class="dropdown-toggle text-white d-block" href="#" id="messagingDropdown"
             role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-comments"></i> Live Messaging
          </a>
          <div class="dropdown-menu" aria-labelledby="messagingDropdown" id="sidebar-msg-dropdown">
            <a href="{{ url_for('user.dashboard' )}}" class="dropdown-item d-flex justify-content-between align-items-center">
              <span>Messenger</span>
              <span class="badge badge-primary" id="messenger-badge">0</span>
            </a>
            <a href="/user/view_chat?platform=Instagram" class="dropdown-item d-flex justify-content-between align-items-center">
              <span>Instagram</span>
              <span class="badge badge-primary" id="instagram-badge">0</span>
            </a>
          </div>
        </div>
        <a href="#"><i class="fas fa-cog"></i> Settings</a>
        
      </nav>
      <main class="offset-md-2 col-md-10 py-0" style="max-height: calc(100vh - 56px); overflow-y: auto;">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-message">
              {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
  if (!window.socket) {
    window.socket = io();  // This initializes the socket only once
  }
</script>
  
  <script>
   
    $(document).ready(function () {
      setTimeout(function () {
        $('.flash-message .alert').alert('close');
      }, 4000); // 4 seconds
    });
  
    



  function showNewMessageToast(senderName, message) {
    const toast = document.createElement("div");
    toast.className = "toast show text-white bg-info border-0 mb-2";
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.zIndex = "9999";

    toast.innerHTML = `
      <div class="toast-body d-flex justify-content-between align-items-center">
        <span>ðŸ“© New message from <strong>${senderName}</strong></span>
        <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close" style="opacity: 1;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    `;

    document.body.appendChild(toast);
    setTimeout(() => $(toast).toast('hide'), 4000);
  }

  function updateNotificationBell(senderName) {
    const badge = document.getElementById("notif-badge");
    const dropdown = document.getElementById("notif-dropdown");

    // Enable badge
    badge.classList.remove("d-none");

    // Get time
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Remove "no message" text if exists
    if (dropdown.innerHTML.includes("No new messages")) {
        dropdown.innerHTML = "";
    }

    // Avoid duplicate sender entries
    const existingItems = dropdown.querySelectorAll('.dropdown-item');
    for (let el of existingItems) {
      if (el.innerText.includes(senderName)) {
        el.remove();
      }
    }

    // Add message to dropdown
    const item = document.createElement("div");
    item.className = "dropdown-item d-flex justify-content-between align-items-start";
    item.innerHTML = `
        <div>
        ðŸ“© <strong>${senderName}</strong><br>
        <small class="text-muted">New message</small>
        </div>
        <small class="text-muted ml-2">${timeString}</small>
    `;
    dropdown.prepend(item);
}

function updateSidebarDropdown(platform = "Messenger") {
  const badgeId = platform === "Messenger" ? "messenger-badge" : "instagram-badge";
  const badge = document.getElementById(badgeId);
  if (badge) {
    let current = parseInt(badge.textContent) || 0;
    badge.textContent = current + 1;
  }
}

function fetchUnreadNotifications() {
  fetch("{{ url_for('user.unread_notifications') }}")
    .then(response => response.json())
    .then(data => {
    const dropdown = document.getElementById("notif-dropdown");
    const badge = document.getElementById("notif-badge");
    const messengerBadge = document.getElementById("messenger-badge");
    const instagramBadge = document.getElementById("instagram-badge");
    console.log(data)
    dropdown.innerHTML = "";
    let count = 0;

    if (data.notifications.length > 0) {
      data.notifications.forEach(notification => {
        const item = document.createElement("div");
        console.log("in noti")
        item.className = "dropdown-item d-flex justify-content-between align-items-start";
        item.innerHTML = `
            <div>
            ðŸ“© <strong>${notification.sender_name}</strong><br>
            <small class="text-muted">New message</small>
            </div>
            <small class="text-muted ml-2">${notification.time}</small>
        `;
        dropdown.appendChild(item);
        count++;
      });

      badge.textContent = data.notification_count;
      badge.classList.remove("d-none");
      messengerBadge.textContent = data.messenger_unread_messages;
           instagramBadge.textContent = data.instagram_msg_count;

    } else {
      badge.classList.add("d-none");
      messengerBadge.textContent = data.messenger_unread_messages;
      instagramBadge.textContent = data.instagram_msg_count;
      
      dropdown.innerHTML = `<span class="text-muted small">No new messages</span>`;
    }
    })
    .catch(error => console.error("Error fetching notifications:", error));
}


// Fetch on page load
document.addEventListener("DOMContentLoaded", function () {
    
    socket.on("new_message", function(data) {
  // Always trigger
  showNewMessageToast(data.sender_name, data.content);
  updateNotificationBell(data.sender_name);
  updateSidebarDropdown(data.platform);
});
  fetchUnreadNotifications();

  // Mark notifications as read when the notification dropdown is opened
  document.getElementById("notif-bell").addEventListener("click", function () {
    fetch("/user/notifications/mark_read", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const badge = document.getElementById("notif-badge");
        badge.classList.add("d-none");
      }
    })
    .catch(error => console.error("Error marking notifications as read:", error));
  });
});
  </script>
  {% block scripts %}

  {% endblock %}
</body>
</html>
